{"version":3,"sources":["../../../../../src/client/components/react-dev-overlay/utils/turbopack-hot-reloader-common.ts"],"sourcesContent":["import type { TurbopackMessageAction } from '../../../../server/dev/hot-reloader-types'\nimport type { Update as TurbopackUpdate } from '../../../../build/swc/types'\n\ninterface HmrUpdate {\n  updatedModules: Set<string>\n  startMsSinceEpoch: number\n  endMsSinceEpoch: number\n}\n\nexport class TurbopackHmr {\n  #updatedModules: Set<string>\n  #startMsSinceEpoch: number | undefined\n  #lastUpdateMsSinceEpoch: number | undefined\n\n  constructor() {\n    this.#updatedModules = new Set()\n  }\n\n  onBuilding() {\n    this.#lastUpdateMsSinceEpoch = undefined\n    this.#startMsSinceEpoch = Date.now()\n  }\n\n  onTurbopackMessage(msg: TurbopackMessageAction) {\n    this.#lastUpdateMsSinceEpoch = Date.now()\n    const updatedModules = extractModulesFromTurbopackMessage(msg.data)\n    for (const module of updatedModules) {\n      this.#updatedModules.add(module)\n    }\n  }\n\n  onBuilt(): HmrUpdate | null {\n    // it's possible for `this.#startMsSinceEpoch` to not be set if this was the initial\n    // computation, just return null in this case.\n    if (this.#startMsSinceEpoch == null) {\n      return null\n    }\n    const result = {\n      updatedModules: this.#updatedModules,\n      startMsSinceEpoch: this.#startMsSinceEpoch!,\n      // Turbopack has a debounce which causes every BUILT message to appear\n      // 30ms late. We don't want to include this latency in our reporting, so\n      // prefer to use the last TURBOPACK_MESSAGE time.\n      endMsSinceEpoch: this.#lastUpdateMsSinceEpoch ?? Date.now(),\n    }\n    this.#updatedModules = new Set()\n    return result\n  }\n}\n\nfunction extractModulesFromTurbopackMessage(\n  data: TurbopackUpdate | TurbopackUpdate[]\n): Set<string> {\n  const updatedModules: Set<string> = new Set()\n\n  const updates = Array.isArray(data) ? data : [data]\n  for (const update of updates) {\n    // TODO this won't capture changes to CSS since they don't result in a \"merged\" update\n    if (\n      update.type !== 'partial' ||\n      update.instruction.type !== 'ChunkListUpdate' ||\n      update.instruction.merged === undefined\n    ) {\n      continue\n    }\n\n    for (const mergedUpdate of update.instruction.merged) {\n      for (const name of Object.keys(mergedUpdate.entries)) {\n        const res = /(.*)\\s+\\[.*/.exec(name)\n        if (res === null) {\n          console.error(\n            '[Turbopack HMR] Expected module to match pattern: ' + name\n          )\n          continue\n        }\n\n        updatedModules.add(res[1])\n      }\n    }\n  }\n\n  return updatedModules\n}\n"],"names":["TurbopackHmr","onBuilding","undefined","Date","now","onTurbopackMessage","msg","updatedModules","extractModulesFromTurbopackMessage","data","module","add","onBuilt","result","startMsSinceEpoch","endMsSinceEpoch","Set","constructor","updates","Array","isArray","update","type","instruction","merged","mergedUpdate","name","Object","keys","entries","res","exec","console","error"],"mappings":";;;;+BASaA;;;eAAAA;;;;;IACX,qFACA,2FACA;AAHK,MAAMA;IASXC,aAAa;QACX,kCAAA,IAAI,EAAC,yBAAA,2BAA0BC;QAC/B,kCAAA,IAAI,EAAC,oBAAA,sBAAqBC,KAAKC,GAAG;IACpC;IAEAC,mBAAmBC,GAA2B,EAAE;QAC9C,kCAAA,IAAI,EAAC,yBAAA,2BAA0BH,KAAKC,GAAG;QACvC,MAAMG,iBAAiBC,mCAAmCF,IAAIG,IAAI;QAClE,KAAK,MAAMC,UAAUH,eAAgB;YACnC,kCAAA,IAAI,EAAC,iBAAA,iBAAgBI,GAAG,CAACD;QAC3B;IACF;IAEAE,UAA4B;QAC1B,oFAAoF;QACpF,8CAA8C;QAC9C,IAAI,kCAAA,IAAI,EAAC,oBAAA,uBAAsB,MAAM;YACnC,OAAO;QACT;;QACA,MAAMC,SAAS;YACbN,cAAc,EAAE,kCAAA,IAAI,EAAC,iBAAA;YACrBO,iBAAiB,EAAE,kCAAA,IAAI,EAAC,oBAAA;YACxB,sEAAsE;YACtE,wEAAwE;YACxE,iDAAiD;YACjDC,iBAAiB,2DAAA,kCAAA,IAAI,EAAC,yBAAA,8FAA2BZ,KAAKC,GAAG;QAC3D;QACA,kCAAA,IAAI,EAAC,iBAAA,mBAAkB,IAAIY;QAC3B,OAAOH;IACT;IAjCAI,aAAc;QAJd,4BAAA;;mBAAA,KAAA;;QACA,4BAAA;;mBAAA,KAAA;;QACA,4BAAA;;mBAAA,KAAA;;QAGE,kCAAA,IAAI,EAAC,iBAAA,mBAAkB,IAAID;IAC7B;AAgCF;AAEA,SAASR,mCACPC,IAAyC;IAEzC,MAAMF,iBAA8B,IAAIS;IAExC,MAAME,UAAUC,MAAMC,OAAO,CAACX,QAAQA,OAAO;QAACA;KAAK;IACnD,KAAK,MAAMY,UAAUH,QAAS;QAC5B,sFAAsF;QACtF,IACEG,OAAOC,IAAI,KAAK,aAChBD,OAAOE,WAAW,CAACD,IAAI,KAAK,qBAC5BD,OAAOE,WAAW,CAACC,MAAM,KAAKtB,WAC9B;YACA;QACF;QAEA,KAAK,MAAMuB,gBAAgBJ,OAAOE,WAAW,CAACC,MAAM,CAAE;YACpD,KAAK,MAAME,QAAQC,OAAOC,IAAI,CAACH,aAAaI,OAAO,EAAG;gBACpD,MAAMC,MAAM,cAAcC,IAAI,CAACL;gBAC/B,IAAII,QAAQ,MAAM;oBAChBE,QAAQC,KAAK,CACX,uDAAuDP;oBAEzD;gBACF;gBAEAnB,eAAeI,GAAG,CAACmB,GAAG,CAAC,EAAE;YAC3B;QACF;IACF;IAEA,OAAOvB;AACT"}